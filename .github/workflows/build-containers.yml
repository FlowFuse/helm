on: 
  push: 
    tags:
      - "v*.*.*"

jobs:
  build_application_container:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          repository: 'flowforge/helm'
          path: 'helm'
      - name: Docker Meta Data
        uses: docker/metadata-action@v3
        with:
          tags: |
            type=semver,event=tag,pattern={{version}}
          images: |
            flowforge/forge-k8s
      - name: Setup QEMU
        uses: docker/setup-qemu-action@v1
      - name: Setup Docker buildx
        uses: docker/setup-buildx-action@v1
      - name: docker login
        uses: docker/login-action@v1
        with:
          username: flowforge
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
      - name: Build and push FlowForge Application container
        uses: docker/build-push-action@v2
        with:
          context: helm/flowforge-container
          file: helm/flowforge-contianer/Dockerfile
          platforms: linux/amd64, linux/arm64
          push: true
      # - name: Build FlowForge application container
      #   working-directory: helm
      #   env:
      #     IMAGE_TAG: ${{ github.ref_name }}
      #     CONTAINER_NAME: flowforge/forge-k8s
      #   run: |
      #     docker build flowforge-container -t $CONTAINER_NAME:$IMAGE_TAG
      #     echo ${{secrets.DOCKER_HUB_PASSWORD}} | docker login -u flowforge --password-stdin
      #     docker push $CONTAINER_NAME:$IMAGE_TAG
  build_nodered_container:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          repository: 'flowforge/helm'
          path: 'helm'
      - name: Docker Meta Data
        uses: docker/metadata-action@v3
        with:
          tags: |
            type=semver,event=tag,pattern={{version}}
          flavors: |
            latest=false
          images: |
            flowforge/node-red
      - name: Setup QEMU
        uses: docker/setup-qemu-action@v1
      - name: Setup Docker buildx
        uses: docker/setup-buildx-action@v1
      - name: docker login
        uses: docker/login-action@v1
        with:
          username: flowforge
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
      - name: Build and push FlowForge Application container
        uses: docker/build-push-action@v2
        with:
          context: helm/flowforge-container
          file: helm/flowforge-contianer/Dockerfile
          platforms: linux/amd64, linux/arm64
          push: true
      # - name: Build Node-RED Stack container
      #   working-directory: helm
      #   env:
      #     IMAGE_TAG: ${{ github.ref_name }}
      #     CONTAINER_NAME: flowforge/node-red
      #   run: |
      #     docker build flowforge-container -t $CONTAINER_NAME:$IMAGE_TAG
      #     echo ${{secrets.DOCKER_HUB_PASSWORD}} | docker login -u flowforge --password-stdin
      #     docker push $CONTAINER_NAME:$IMAGE_TAG