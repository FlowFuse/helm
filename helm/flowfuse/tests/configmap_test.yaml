# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: test configmap
templates:
  - configmap.yaml
set:
  forge.domain: "chart-unit-tests.com"
tests:
  - it: should not include projectProbes by default
    asserts:
      - notMatchRegex:
          path: data["flowforge.yml"]
          pattern: "projectProbes:"

  - it: should not render projectProbes when set to empty object
    set:
      forge.projectProbes: {}
    asserts:
      - notMatchRegex:
          path: data["flowforge.yml"]
          pattern: "projectProbes:"

  - it: should render livenessProbe when provided
    set:
      forge.projectProbes:
        livenessProbe:
          httpGet:
            path: /healthz
            port: 1880
          initialDelaySeconds: 5
          periodSeconds: 10
    asserts:
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "projectProbes:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "projectProbes:\\n\\s{2,}livenessProbe:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "livenessProbe:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "httpGet:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "path: /healthz"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "port: 1880"

  - it: should render readinessProbe only when provided
    set:
      forge.projectProbes:
        readinessProbe:
          httpGet:
            path: /ready
            port: 1880
          initialDelaySeconds: 3
          periodSeconds: 5
    asserts:
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "projectProbes:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "projectProbes:\\n\\s{2,}readinessProbe:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "readinessProbe:"
      - notMatchRegex:
          path: data["flowforge.yml"]
          pattern: "livenessProbe:"
      - notMatchRegex:
          path: data["flowforge.yml"]
          pattern: "startupProbe:"

  - it: should render startupProbe when provided
    set:
      forge.projectProbes:
        startupProbe:
          httpGet:
            path: /startup
            port: 1880
          failureThreshold: 30
          periodSeconds: 5
    asserts:
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "projectProbes:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "projectProbes:\\n\\s{2,}startupProbe:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "startupProbe:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "path: /startup"

  - it: should render all three probes when all are provided
    set:
      forge.projectProbes:
        livenessProbe:
          httpGet:
            path: /healthz
            port: 1880
        readinessProbe:
          httpGet:
            path: /ready
            port: 1880
        startupProbe:
          httpGet:
            path: /startup
            port: 1880
    asserts:
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "projectProbes:"
      # Ensure all three probes are nested under projectProbes (order independent)
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "projectProbes:\\n\\s{2,}livenessProbe:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "(?s)projectProbes:.*\\n\\s{2,}readinessProbe:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "(?s)projectProbes:.*\\n\\s{2,}startupProbe:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "livenessProbe:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "readinessProbe:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "startupProbe:"
  - it: should not render containerSecurityContext by default
    asserts:
      - notMatchRegex:
          path: data["flowforge.yml"]
          pattern: "containerSecurityContext:"

  - it: should not render podSecurityContext when forge.projectPodSecurityContext is null
    set:
      forge.projectPodSecurityContext: null
    asserts:
      - notMatchRegex:
          path: data["flowforge.yml"]
          pattern: "podSecurityContext:"

  - it: should render podSecurityContext when forge.projectPodSecurityContext is set
    set:
      forge.projectPodSecurityContext:
        runAsUser: 2001
        runAsGroup: 2002
        fsGroup: 2003
    asserts:
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "podSecurityContext:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "runAsUser: 2001"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "runAsGroup: 2002"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "fsGroup: 2003"

  - it: should render containerSecurityContext when forge.projectContainerSecurityContext is set
    set:
      forge.projectContainerSecurityContext:
        allowPrivilegeEscalation: false
        runAsNonRoot: true
        readOnlyRootFilesystem: true
    asserts:
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "containerSecurityContext:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "allowPrivilegeEscalation: false"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "runAsNonRoot: true"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "readOnlyRootFilesystem: true"

  - it: should render both podSecurityContext and containerSecurityContext when both are set
    set:
      forge.projectPodSecurityContext:
        runAsUser: 2001
        runAsGroup: 2002
      forge.projectContainerSecurityContext:
        runAsNonRoot: true
        capabilities:
          drop:
            - ALL
    asserts:
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "podSecurityContext:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "runAsUser: 2001"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "runAsGroup: 2002"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "containerSecurityContext:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "runAsNonRoot: true"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "capabilities:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "drop:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "- ALL"

  # Expert feature tests
  - it: should not render expert configuration by default
    asserts:
      - notMatchRegex:
          path: data["flowforge.yml"]
          pattern: "expert:"

  - it: should not render expert configuration when expert is disabled
    set:
      forge.expert:
        enabled: false
    asserts:
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "expert:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "enabled: false"

  - it: should render expert configuration when expert is enabled
    set:
      forge.expert:
        enabled: true
        service:
          url: "https://expert.example.com"
          token: "test-token"
    asserts:
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "expert:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "enabled: true"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "token: <%= ENV\\['EXPERT_TOKEN'\\] %>"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "url: https://expert\\.example\\.com"

  - it: should render expert configuration with custom requestTimeout
    set:
      forge.expert:
        enabled: true
        service:
          url: "https://expert.example.com"
          token: "test-token"
        requestTimeout: 30000
    asserts:
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "expert:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "requestTimeout: 30000"

  - it: should render expert configuration with default requestTimeout
    set:
      forge.expert:
        enabled: true
        service:
          url: "https://expert.example.com"
          token: "test-token"
    asserts:
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "expert:"
      - matchRegex:
          path: data["flowforge.yml"]
          pattern: "requestTimeout: 60000"
